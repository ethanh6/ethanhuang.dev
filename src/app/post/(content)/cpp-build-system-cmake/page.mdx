export const metadata = {
  title: 'C++ Build System - CMake',
  description: 'Process of compiling a C++ project and CMake.',
  slug: 'cpp-build-system-cmake',
  date: '2023-03-12',
  type: 'Post',
  language: 'mandarin',
  tags: 'Build System, C++, CMake',
};

# C++ build system - CMake

é–‹ç™¼ C++ æœƒç”¨åˆ°å¾ˆå¤šå·¥å…·ï¼Œé™¤äº†åŸºæœ¬çš„ç·¨è¼¯å™¨ Text Editor è·Ÿç·¨è­¯å™¨ Compilerï¼Œé‚„æœ‰ï¼š

- Linters
- Tests
- Static Code Analysis tools
- Formatting tools
- CI / CD
- Version Control (Git)
- Debugger
- Package manager
- OS
- Toolchain
- Build System

é€™ç¯‡æ–‡ç« ä»‹ç´¹äº† Build System çš„è‡ªå‹•åŒ–æµç¨‹ï¼Œä¸¦è¨è«–äº†ä½¿ç”¨ Build System çš„å¥½è™•ï¼Œä»¥åŠ CMake æ˜¯å¦‚ä½•ç”Ÿæˆ Build System çš„ã€‚ä½¿ç”¨ CMake å¯ä»¥è®“æ•´å€‹ç·¨è­¯æµç¨‹è·¨å¹³å°ä¸”æ›´å®¹æ˜“ç¶­è­·ï¼Œä¸¦ä¸”å¯ä»¥è‡ªå‹•åŒ–ç¹ç‘£çš„å·¥ä½œï¼Œè®“é–‹ç™¼è€…å°ˆæ³¨æ–¼å¯«ç¨‹å¼ç¢¼ã€‚

# C++ çš„ç·¨è­¯éç¨‹

é¦–å…ˆè¦å¾ç·¨è­¯èªªèµ·ã€‚

äº‹å¯¦ä¸Šï¼Œæˆ‘å€‘åœ¨å»ºæ§‹ C++ project æ™‚ï¼Œå¯ä»¥å®Œå…¨ä¸ä½¿ç”¨ CMake é€™é¡ build systemï¼Œåªæ˜¯å¦‚æ­¤ç¼ºé»æ˜¯é€™æ¨£çš„å°ˆæ¡ˆåœ¨å»ºæ§‹æ™‚æœƒå¾ˆé›£ç¶­è­·ï¼Œè€Œä¸”ç¼ºä¹ scalibilityã€‚

ç‚ºäº†èªªæ˜ Build system çš„å¥½ç”¨ä¹‹è™•ï¼Œæˆ‘å€‘å…ˆçœ‹çœ‹å¦‚æœä¸ç”¨ build system çš„è©±ï¼Œéœ€è¦çš„æ­¥é©Ÿæœƒå¤šç¹ç‘£ã€‚

Compiler åœ¨æŠŠ source file (e.g. main.cpp) è½‰æ›æˆ executable (e.g. a.out) çš„éç¨‹ä¸­éœ€è¦å¾ˆå¤šå€‹æ­¥é©Ÿï¼Œä½†åˆå­¸æ™‚é€šå¸¸ç”¨ä¸€å€‹æŒ‡ä»¤å°±è¶³å¤ äº†ï¼Œå› ç‚º compiler éƒ½æœƒå¹«ä½ è™•ç†å¥½æ‰€æœ‰çš„äº‹æƒ…ã€‚

å‡è¨­æˆ‘å€‘æœ‰å€‹ç°¡å–®çš„ç¨‹å¼ `main.cpp`

```cpp
#include <iostream>

int main() {
	std::cout << "hello c++" << std::endl;
}
```

å¯ä»¥ä½¿ç”¨ clang++ ç·¨è­¯ `main.cpp` é€™å€‹ source fileï¼ŒåŒæ™‚ç”¢ç”Ÿäº† executable `main`

```bash
$ clang++ -o main main.cpp
```

ä½†åœ¨èƒŒå¾Œï¼Œclang++ï¼Œä»¥åŠæ‰€æœ‰å…¶ä»–çš„ compilerï¼Œéƒ½å¹«ä½ åšäº†é€™äº›äº‹æƒ…ï¼š

<pre>
  ğŸ’¡ Source file (`main.cpp`) â†’ [ Preprocessor ] â†’ preprocessed file (`main.ii`)
  â†’ [ Compiler ] â†’ assembly file (`main.s`) â†’ [ Assembler ] â†’ object file
  (`main.o`) â†’ [ Linker ] (with some libraries if needed) â†’ executable (`a.out`
  or `main`)
</pre>

### Preprocess

åœ¨é€™å€‹æ­¥é©Ÿæœƒè—‰ç”± preprocessor ç”¢ç”Ÿ preprocessed fileã€‚ä¸»è¦åšçš„äº‹æƒ…æ˜¯ "#include expansion"ï¼Œå°±æ˜¯æŠŠæ‰€æœ‰ `#include` åˆ°çš„æ±è¥¿ç›´æ¥è¤‡è£½è²¼ä¸Šåˆ°é€™å€‹æª”æ¡ˆè£¡é¢ï¼Œç„¶å¾Œæœƒç”¢ç”Ÿ translation unitã€‚

è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘å€‘éœ€è¦æŠŠè¼¸å‡ºå¯«é“ `main.ii` è£¡é¢ï¼Œæ–¹ä¾¿æˆ‘å€‘çœ‹ä¹‹å¾Œçš„éç¨‹ã€‚

```bash
$ clang++ -E main.cpp > main.ii
```

### Compilation

æ ¹æ“šæˆ‘å€‘çš„ preprocessed fileï¼Œé€™ä¸€æ­¥æœƒç”¢ç”Ÿå¾ˆé†œä½†é‚„æ˜¯å‹‰å¼·å¯ä»¥ç†è§£çš„ assembly code (`main.s`)ï¼Œå…§å®¹æœƒæ ¹æ“šä½¿ç”¨è€…çš„ç³»çµ±è€Œä¸åŒï¼Œä½†é€šå¸¸æˆ‘å€‘ä¸æœƒéœ€è¦å»çœ‹è£¡é¢çš„å…§å®¹ã€‚

é€™ä¸€æ­¥æœƒè‡ªå‹•ç”¢ç”Ÿ `main.s`ï¼Œä¸éœ€è¦ redirect outputã€‚

```bash
$ clang++ -S main.ii
```

### Assembly

æŠŠ assembly code è½‰æˆ machine codeï¼Œç„¶å¾Œæœƒç”¢ç”Ÿ object file `main.o`ã€‚åˆ°é€™è£¡ `main.o` æœƒæ˜¯ä¸€å€‹äºŒé€²ä½æª”æ¡ˆï¼Œæ˜¯å°äººé¡å®Œå…¨æ²’æœ‰é–±è®€æ„ç¾©çš„æª”æ¡ˆã€‚

```bash
$ clang++ -c main.s
```

### Linking

Linker ä¸»è¦çš„ä½œç”¨æ˜¯ï¼ŒæŠŠ function declaration é€£çµåˆ°å®ƒçš„ compiled implementationï¼Œä¹Ÿå°±æ˜¯ object filesã€‚

é€™å€‹æ­¥é©Ÿæœƒ link ä¸åŒçš„ libraries (åœ¨é€™å€‹ä¾‹å­ä¸­ä¸éœ€è¦)ï¼Œé€²è€Œç”¢ç”Ÿ executable file `main`ã€‚

```bash
$ clang++ main.o -o main
```

ï¼ˆè¨»ï¼šå¦‚æœéœ€è¦ä»”ç´°çœ‹ clang++ çš„ä½¿ç”¨èªªæ˜ï¼Œå¯ä»¥ç›´æ¥ç”¨ `man`ï¼‰

```bash
$ man clang++
```

é€™å€‹ä¾‹å­å¾ˆç°¡å–®ï¼Œä½†ä»–æœ‰ä¸€å€‹å‰ææ˜¯æ‰€æœ‰çš„ code éƒ½å¯«åœ¨ `main.cpp` è£¡é¢ï¼Œè€Œé€™é¡¯ç„¶åœ¨ç¾å¯¦ä¸­æ˜¯ä¸å¯èƒ½çš„ã€‚è€Œä¸”æˆ‘å€‘ä¹Ÿæ²’æœ‰ä½¿ç”¨ Libraryã€‚ä¸€èˆ¬ä¾†èªªï¼Œé™¤äº† C++ standard librariesï¼Œå¦‚ `<iostream>`ã€`<vector>` ç­‰ï¼Œæˆ‘å€‘é‚„æœƒç”¨åˆ°ä»–äººå¯«çš„ä»¥åŠè‡ªå·±å¯«çš„ libraryï¼Œè€Œé€™äº› library é€šå¸¸æœƒå› ç‚ºè¼ƒå¥½ç¶­è­·ç­‰çš„åŸå› ï¼Œåˆ†åˆ¥æ”¾åœ¨å¤šå€‹æª”æ¡ˆä¸­ (`*.hpp` , `*.cpp`)ã€‚

# ä»€éº¼æ˜¯ Libraryï¼Ÿ

Library å°±æ˜¯å·²ç¶“å¯«å¥½çš„ codeï¼Œæ‰“åŒ…å¥½äº†ï¼Œå…¶ä»–äºº (åŒ…æ‹¬è‡ªå·±) å°±èƒ½æ–¹ä¾¿ä½¿ç”¨ã€‚

ä½¿ç”¨è€…åœ¨ç”¨ Library æ™‚ï¼Œæœƒéœ€è¦å…©å€‹æ±è¥¿ï¼š

- Object file ã€‚é€™æ˜¯ç·¨è­¯å¥½çš„ implementationã€‚ç°¡å–®ä¾†èªªå°±æ˜¯ç¨‹å¼çš„æœ¬é«”ã€‚
  - å¯ä»¥æ ¹æ“šç¨‹å¼çš„æœ¬é«”åœ¨å“ªåˆ†æˆå…©ç¨®ï¼šstatic library & dynamic libraryã€‚
  - ç”± `*.cpp` æª”ç·¨è­¯è€Œæˆã€‚
- Header fileã€‚é€™æ˜¯å‘Šè¨´ä½¿ç”¨è€…é€™å€‹ç¨‹å¼è¦å¦‚ä½•ä½¿ç”¨ï¼Œå°±æ˜¯å»£ç¾©çš„ API æ¦‚å¿µã€‚
  - å°±æ˜¯ `*.hpp`ã€‚

è¨˜å¾— Linker çš„åŠŸèƒ½å—ï¼Ÿ

<aside>
ğŸ’¡ Linker maps the a function declaration (header file) to its compiled implementation (object file)ã€‚

</aside>

æ‰€ä»¥ library è·Ÿ linker çš„ä½¿ç”¨æ˜¯åˆ†ä¸é–‹çš„ã€‚

é€™è£¡å¯«ä¸€å€‹ç°¡å–®çš„ library `greet()` ç‚ºä¾‹å­èªªæ˜ã€‚

æŠŠ `greet()` çš„ function declaration è·Ÿ definition åˆ†æˆä¸åŒçš„æª”æ¡ˆ (modules)ï¼Œä¸¦åœ¨ `main.cpp` ä¸­å‘¼å«ã€‚

`greet.hpp` - Declaration

```cpp
#pragma once  // ensure this file is included only once
void greet();
```

`greet.cpp` - Definition

```cpp
#include <iostream>
#include "greet.hpp"
void greet() { std::cout << "hello there" << std::endl; }
```

`main.cpp` - Calling from other program

```cpp
#include "greet.hpp"
int main() {
	greet();
	return 0;
}
```

æœ‰äº† source fileï¼Œè¦å»ºæ§‹ Library `greet` éœ€è¦ä¸‹åˆ—å¹¾å€‹æ­¥é©Ÿï¼š

### Compile the modules

é€™æ­¥é©ŸåŒ…å«äº†å‰é¢æåˆ°çš„ preprocess, compilation, assemblyï¼Œæœƒç”¢ç”Ÿ greet é€™å€‹ module çš„ object file `greet.o`ã€‚

```bash
$ clang++ -c greet.cpp
```

### Create libraries archive

ç”¨æ‰“åŒ…å·¥å…· `ar` ä»¥åŠåƒæ•¸ `rcs`ï¼Œå°‡ `greet.o` æ‰“åŒ…æˆä¸€å€‹ libraryï¼Œå‘½åç‚º `libgreet.a`ã€‚è¦æ³¨æ„ library å¿…é ˆå‘½åç‚º`lib<library name>.a`ï¼Œå¦å‰‡ä¹‹å¾Œ linker æœƒæŠ“ä¸åˆ°ã€‚

é€™å€‹ä¾‹å­åªæœ‰å°‡ä¸€å€‹æª”æ¡ˆ `greet.o` æ‰“åŒ…ï¼Œå¯¦éš›ä¸Šå¯ä»¥å°‡å¾ˆå¤šå€‹æª”æ¡ˆæ‰“åŒ…æˆä¸€å€‹ libraryã€‚

```bash
$ ar rcs libgreet.a greet.o <other_modules_here>
```

### Compile main application

åƒä¹‹å‰ä¸€æ¨£ç”¢ç”Ÿ `main.cpp` çš„ object file `main.o`ã€‚

```bash
$ clang++ -c main.cpp
```

### Link main application to libraries

æœ‰äº†ä¸»è¦ç¨‹å¼ `main.o` è·Ÿ library `greet`ï¼Œå°±å¯ä»¥æ‰“åŒ…æˆæœ€å¾Œçš„ executable `main`ã€‚

- `-L .` add current directory so library search path.
- `-lgreet` å‘Šè¨´ compiler è¦æ‰¾ `greet` é€™å€‹ libraryã€‚æ‰€ä»¥å‰é¢çš„å‘½åæ­£ç¢ºæ€§å¾ˆé‡è¦ã€‚

```bash
$ clang++ main.o -o main -L . -lgreet
```

åˆ°ç›®å‰ç‚ºæ­¢æˆ‘å€‘å»ºç«‹äº†ä¸€å€‹ library `greet`ï¼Œä¸¦ä¸”æˆåŠŸçš„é€£çµåˆ°ä¸»è¦çš„ç¨‹å¼ `main` è£¡é¢ã€‚

ä½†æ˜¯å°æ–¼æ‰€æœ‰çš„ librariesï¼Œæˆ‘å€‘éƒ½è¦è·‘éä»¥ä¸Š 4 å€‹æ­¥é©Ÿï¼Œéå¸¸çš„éº»ç…©ã€‚è€Œä¸”ç•¶ project è¦æ¨¡è¶Šä¾†è¶Šå¤§ï¼Œè¦å» maintain é€™ä¸€å¥—æµç¨‹æ˜¯å¾ˆå›°é›£çš„äº‹ã€‚

æ‰€ä»¥æˆ‘å€‘éœ€è¦ build system ä¾†è‡ªå‹•è©±é€™äº›å·¥ä½œã€‚

# ä»€éº¼æ˜¯ Build Systemï¼Ÿ

Build system å°±æ˜¯ä¸€å¥—è‡ªå‹•åŒ–å·¥å…·ï¼Œè®“ä½ ç”¨ä¸€å€‹ script å°±å¯ä»¥è‡ªå‹•åŒ–ä¸Šè¿°çš„å»ºæ§‹æµç¨‹ï¼Œæœ€å¥½å¯ä»¥è·¨å¹³å°ï¼Œä¸¦ä¸”å®¹æ˜“é–±è®€ä¸”å¥½ç¶­è­·ã€‚

ä¸€èˆ¬ä¾†èªªï¼Œä½¿ç”¨è€…å¯ä»¥å¾ˆ hardcore çš„ç”¨ shell scriptï¼Œæˆ–æ›´å¥½çš„ Makefile å»åšé€™ä»¶äº‹ï¼Œä½†é€™ç¯‡æ–‡ç« è¦è¨è«–çš„æ˜¯ CMakeã€‚

é¦–å…ˆå¿…é ˆè¦ç†è§£çš„æ˜¯ï¼ŒCMake ä¸¦ä¸æ˜¯ä¸€å€‹ build systemï¼Œè€Œæ˜¯ä¸€å€‹ build system generatorã€‚

C++ æœ¬èº«æ˜¯è·¨å¹³å°çš„ç¨‹å¼èªè¨€ï¼Œä½† C++ çš„ç·¨è­¯å·¥å…·å»ä¸æ˜¯ã€‚æ‰€ä»¥å°±è¦ä½¿ç”¨ CMake é€™é¡çš„è·¨å¹³å°å·¥å…·å»ç”¢ç”Ÿå°æ‡‰åˆ°ä¸åŒå¹³å°çš„ç·¨è­¯å·¥å…·ï¼Œä¸¦ä¸”é”åˆ°æ˜“è®€å¥½ç¶­è­·çš„ç›®çš„ã€‚

ç°¡è€Œè¨€ä¹‹ï¼Œä½¿ç”¨ CMake æœƒæ ¹æ“šä½¿ç”¨è€…çš„é–‹ç™¼ç³»çµ±ç”¢ç”Ÿä¸€å€‹ build system (å¦‚åœ¨ linux & macOS ä¸Šæ˜¯ Makefile)ï¼Œç„¶å¾Œæˆ‘å€‘å†ä½¿ç”¨é€™å€‹ build system å»å¯¦éš›å»ºæ§‹å‡ºç¨‹å¼ã€‚

é‡æ–°çœ‹ä¸€æ¬¡å‰ä¸€å€‹ä¾‹å­çš„æ‰€æœ‰æŒ‡ä»¤ï¼š

```bash
[1] clang++ -c greet.cpp
[2] ar rcs libgreet.a greet.o <other_modules_here>
[3] clang++ -c main.cpp
[4] clang++ main.o -o main -L . -lgreet
```

åœ¨ `CMakeLists.txt` å°æ‡‰çš„å¯«æ³•ï¼š

```bash
add_library(greet greet.cpp)        # [1] and [2]
add_executable(main main.cpp)       # [3]
target_link_libraries(main greet)   # [4]
```

é¡¯è€Œæ˜“è¦‹ï¼ŒCMake å¤§å¤§ç°¡åŒ–äº†æ‰‹å‹•å»ºæ§‹ç³»çµ±å†—é•·çš„ç·¨è­¯æŒ‡ä»¤ã€‚

æ‰€æœ‰ CMake æœ‰é—œçš„ build file éƒ½æ”¾åœ¨ `./build` è£¡é¢ï¼Œé€™æ¨£å¯ä»¥ä¿æŒ project folder çš„ä¹¾æ·¨ï¼Œå°±ç®— build éç¨‹å‡ºäº†å•é¡Œï¼Œæ•´å€‹ `build` folder åˆªæ‰é‡ä¾†éƒ½æ²’å•é¡Œã€‚

é€™è£¡ä¹Ÿç”¨ä¸€å€‹ç°¡å–®çš„ `CMakeLists.txt` èªªæ˜ã€‚

### ç°¡å–®çš„ CMake example

å»¶çºŒä¸Šé¢çš„ç¯„ä¾‹ï¼Œä¸¦ä¸”åŠ ä¸Š `CMakeLists.txt`ï¼š

```
<project_name>
	â”œâ”€â”€ CMakeLists.txt
	â”œâ”€â”€ build/
	â”‚Â Â  â””â”€â”€ ... cmake generated files go here
	â”œâ”€â”€ greet.cpp
	â”œâ”€â”€ greet.hpp
	â””â”€â”€ main.cpp
```

`CMakeLists.txt` å…§å®¹å¦‚ä¸‹ï¼š

```
cmake_minimum_required(VERSION 3.15)
project(my_project_name)

add_library(greet greet.cpp)
add_executable(main main.cpp)
target_link_libraries(main greet)
```

ä½¿ç”¨ CMake çš„æµç¨‹å¦‚ä¸‹ï¼š

```bash
[0] $ cd <project directory>

# Generates a Project Buildsystem with current dir as CMake project root dir
[1] $ cmake -S . -B build

# builds a project, keeps cmake files in build folder
[2] $ cmake --build build

[3] $ make               # build using Make
```

[1] ~ [3] æ˜¯ä½¿ç”¨ CMake ç”¢ç”Ÿä¸€å€‹ makefileï¼Œç„¶å¾Œ [4] å†ä½¿ç”¨ make æŠŠç›®æ¨™å¯¦éš›å»ºæ§‹å‡ºä¾†ã€‚

### ä½¿ç”¨ CMake çš„å…¸å‹ Project æ¶æ§‹

ç•¶ç„¶é‚„éœ€è¦ git ç­‰å·¥å…·ï¼Œä¸éé€™é‚Šå…ˆä¸è¨è«–ã€‚

```bash
<project_name>
	â”œâ”€â”€ CMakeLists.txt
	â”œâ”€â”€ README.md
	â”œâ”€â”€ build                # keep CMake files here
	â”œâ”€â”€ include              # other libraries
	â”‚Â Â  â””â”€â”€ project_name
	â”‚Â Â      â””â”€â”€ some_library.hpp
	â”œâ”€â”€ results              # build result
	â”‚Â Â  â”œâ”€â”€ bin
	â”‚Â Â  â”‚Â Â  â””â”€â”€ main
	â”‚Â Â  â””â”€â”€ lib
	â”‚Â Â      â””â”€â”€ libtools.a
	â”œâ”€â”€ src                   # source files
 	â”‚Â Â  â”œâ”€â”€ CMakeLists.txt
	â”‚Â Â  â””â”€â”€ project_name
	â”‚Â Â      â”œâ”€â”€ CMakeLists.txt
	â”‚Â Â      â”œâ”€â”€ main.cpp
	â”‚Â Â      â”œâ”€â”€ tools.cpp
	â”‚Â Â      â””â”€â”€ tools.hpp
	â””â”€â”€ tests                  # testing tools
    â”œâ”€â”€ CMakeLists.txt
    â””â”€â”€ tests.cpp
```

# Reference

[https://chchwy.github.io/2021/08/cmake-basics/](https://chchwy.github.io/2021/08/cmake-basics/)

[https://cliutils.gitlab.io/modern-cmake/](https://cliutils.gitlab.io/modern-cmake/)

[https://www.ipb.uni-bonn.de/html/teaching/modern-cpp-2021/slides/lecture_1.pdf](https://www.ipb.uni-bonn.de/html/teaching/modern-cpp-2021/slides/lecture_1.pdf)

[https://ithelp.ithome.com.tw/articles/10221101](https://ithelp.ithome.com.tw/articles/10221101)

[https://gitlab.kitware.com/cmake/community/-/wikis/FAQ#how-do-i-use-a-different-compiler](https://gitlab.kitware.com/cmake/community/-/wikis/FAQ#how-do-i-use-a-different-compiler)

[https://stackoverflow.com/questions/45933732/how-to-specify-a-compiler-in-cmake](https://stackoverflow.com/questions/45933732/how-to-specify-a-compiler-in-cmake)

[https://www.youtube.com/watch?v=18c3MTX0PK0&list=PLlrATfBNZ98dudnM48yfGUldqGD0S4FFb](https://www.youtube.com/watch?v=18c3MTX0PK0&list=PLlrATfBNZ98dudnM48yfGUldqGD0S4FFb)

commands to build a project

[https://cmake.org/cmake/help/latest/manual/cmake.1.html#build-a-project](https://cmake.org/cmake/help/latest/manual/cmake.1.html#build-a-project)
